version: 0.2
phases:
  install:
    commands:
      - apt-get install jq
  build:
    commands:
      - bucketAndFile=${CODEBUILD_SOURCE_REPO_URL_BuildArtifact:13}
      - printenv
      - aws codepipeline list-action-executions --pipeline-name sdra-test --filter pipelineExecutionId=$aaa > pipeline-execution.json
      - commitMessage=$(jq -r '.actionExecutionDetails[1].output.executionResult.externalExecutionSummary' pipeline-execution.json)
      - echo $commitMessage
      - commitMessageDashes="${commitMessage// /_}"
      - versionLabel=$CODEBUILD_BUILD_NUMBER-${CODEBUILD_RESOLVED_SOURCE_VERSION:0:7}-${commitMessageDashes:0:15}
      - bucket=$(cut -d'/' -f1 <<< $bucketAndFile)
      - folder1=$(cut -d'/' -f2 <<< $bucketAndFile)
      - folder2=$(cut -d'/' -f3 <<< $bucketAndFile)
      - file=$(cut -d'/' -f4 <<< $bucketAndFile)
      - echo "Creating application version " $versionLabel " from artefacts " $file
      - aws elasticbeanstalk create-application-version --application-name sdra --description "$commitMessage" --version-label $versionLabel --source-bundle S3Bucket="$bucket",S3Key="$folder1/$folder2/$file"
      - echo "Deploying version " $versionLabel
      - aws elasticbeanstalk update-environment --environment-name $environmentName --version-label $versionLabel